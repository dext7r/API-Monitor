<!-- ==================== 自建服务模块 (Self-H) ==================== -->
<div v-show="mainActiveTab === 'self-h'" class="tab-content self-h-tab-content theme-self-h"
    :class="getTabAnimationClass('self-h')">

    <!-- 二级导航栏 -->
    <div class="sec-tabs server-sec-tabs">
        <div class="server-tabs-scroll-wrapper">
            <button class="tab-btn" :class="{ active: openListSubTab === 'files' }" @click="openListSubTab = 'files'">
                <i class="fas fa-folder-open"></i> 文件列表
            </button>
            <button class="tab-btn" :class="{ active: openListSubTab === 'settings' }"
                @click="openListSubTab = 'settings'">
                <i class="fas fa-cog"></i> 设置
            </button>
            <!-- 临时标签页列表 -->
            <button v-for="tab in openListTempTabs" :key="tab.id" class="tab-btn temp-tab"
                :class="{ active: openListSubTab === 'temp' && openListActiveTempTabId === tab.id }"
                @click="handleTabTap(tab.id)" @auxclick.middle.stop="closeOpenListTempTab(tab.id)"
                :title="tab.name + ' (双击关闭)'">
                <i :class="tab.icon || 'fas fa-file'"></i> <span>{{ tab.name }}</span>
            </button>
        </div>
    </div>

    <!-- 内容区域 -->
    <div class="sub-tab-content quick-fade-in">

        <!-- 1. 文件列表 -->
        <div v-if="openListSubTab === 'files'" class="openlist-files-layout">
            <div v-if="!currentOpenListAccount" class="empty-state" style="margin-top: 40px;">
                <div class="empty-icon"><i class="fas fa-plug"></i></div>
                <p>尚未连接 OpenList 实例</p>
                <button class="btn btn-primary" @click="openListSubTab = 'settings'">
                    <i class="fas fa-plus"></i> 前往配置
                </button>
            </div>

            <div v-else class="openlist-main-view">
                <!-- 顶部工具栏 (Header Area) -->
                <div class="openlist-toolbar-standalone">
                    <div class="toolbar-left">
                        <!-- 账号切换 -->
                        <div class="account-pill" v-if="openListAccounts.length > 1">
                            <select :value="currentOpenListAccount?.id"
                                @change="e => selectOpenListAccountById(e.target.value)">
                                <option v-for="acc in openListAccounts" :key="acc.id" :value="acc.id">{{ acc.name }}
                                </option>
                            </select>
                            <i class="fas fa-caret-down"></i>
                        </div>

                        <!-- 面包屑导航 -->
                        <div class="breadcrumb-fluid-container">
                            <button class="bc-node" @click="loadOpenListFiles('/')"><i class="fas fa-home"></i></button>
                            <template v-for="(part, index) in openListPathParts" :key="part.path">
                                <i class="fas fa-chevron-right bc-divider"></i>
                                <button class="bc-node" :class="{ 'active': index === openListPathParts.length - 1 }"
                                    @click="loadOpenListFiles(part.path)">
                                    {{ part.name }}
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- 右侧搜索 -->
                    <div class="toolbar-right">
                        <button class="btn btn-icon-refined" @click="mkdirOpenList" title="新建文件夹"><i
                                class="fas fa-folder-plus"></i></button>
                        <button class="btn btn-icon-refined" @click="loadOpenListFiles(openListPath, true)"
                            title="刷新"><i class="fas fa-sync-alt"
                                :class="{ 'fa-spin': openListFilesLoading }"></i></button>
                    </div>
                </div>

                <!-- 文件列表区域 (Scrolling Area) -->
                <div class="openlist-list-container">
                    <table class="data-table sticky-header" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="col-name" @click="toggleOpenListSort('name')">名称 <i
                                        v-if="openListSortKey === 'name'" class="fas"
                                        :class="openListSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i></th>
                                <th class="col-size" @click="toggleOpenListSort('size')">大小 <i
                                        v-if="openListSortKey === 'size'" class="fas"
                                        :class="openListSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i></th>
                                <th class="col-time hide-on-mobile" @click="toggleOpenListSort('modified')">修改时间 <i
                                        v-if="openListSortKey === 'modified'" class="fas"
                                        :class="openListSortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i></th>
                            </tr>
                        </thead>
                        <tbody v-if="sortedOpenListFiles.length > 0">
                            <tr v-for="file in sortedOpenListFiles" :key="file.name" @click="handleOpenFile(file)"
                                @contextmenu="showFileContextMenu($event, file, openListPath)"
                                @touchstart="handleFileTouchStart($event, file, openListPath)"
                                @touchend="handleFileTouchEnd($event)" @touchmove="handleFileTouchMove()"
                                @auxclick.middle.stop="handleMiddleClickItem(file)">
                                <td class="col-name">
                                    <div class="file-cell-main">
                                        <div class="file-icon-wrapper">
                                            <img v-if="getFileThumbnail(file)" :src="getFileThumbnail(file)"
                                                class="file-thumb-icon" referrerpolicy="no-referrer" loading="lazy"
                                                @mouseenter="showHoverPreview($event, getFileThumbnail(file))"
                                                @mousemove="moveHoverPreview($event)" @mouseleave="hideHoverPreview"
                                                @touchstart.stop="showHoverPreview($event, getFileThumbnail(file))"
                                                @touchend.stop="hideHoverPreview" />
                                            <i v-else :class="getFileIconClass(file)"></i>
                                        </div>
                                        <span class="file-name-text" :title="file.name">{{ file.name }}</span>
                                    </div>
                                </td>
                                <td class="col-size font-mono text-secondary">{{ getOpenListFileSize(file) || '-' }}
                                </td>
                                <td class="col-time text-tertiary hide-on-mobile">{{ formatDateTime(file.modified) }}
                                </td>
                            </tr>
                        </tbody>
                        <!-- 空状态 -->
                        <tbody v-else-if="!openListFilesLoading">
                            <tr>
                                <td colspan="3" style="border: none;">
                                    <div class="openlist-empty-state">
                                        <i class="fas fa-folder-open"></i>
                                        <p>当前目录为空</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- 加载骨架 -->
                    <div v-if="openListFilesLoading" class="list-loading-shimmer">
                        <div v-for="i in 10" :key="i" class="shimmer-row"></div>
                    </div>

                    <!-- README -->
                    <div v-if="openListReadme" class="readme-footer">
                        <div class="readme-label"><i class="fab fa-markdown"></i> README</div>
                        <div class="markdown-body" v-html="renderMarkdown(openListReadme)"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- 2. 设置 -->
        <div v-if="openListSubTab === 'settings'" class="openlist-settings animate-fade-in">
            <div class="panel shadow-sm" style="margin-bottom: 16px;">
                <div class="panel-header" style="padding: 10px;">
                    <div class="panel-title"><i class="fas fa-server text-primary"></i> 实例管理</div>
                </div>
                <div style="padding: 0;">
                    <div v-for="acc in openListAccounts" :key="acc.id" class="setting-item"
                        style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); gap: 12px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span :class="['status-dot', acc.status === 'online' ? 'online' : 'offline']"></span>
                                <span style="font-weight: 600; color: var(--text-primary); font-size: 14px;">{{ acc.name
                                    }}</span>
                            </div>
                            <div
                                style="font-size: 12px; color: var(--text-tertiary); margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ acc.api_url }}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-icon-refined sm" @click="selectOpenListAccount(acc)" title="使用此实例"><i
                                    class="fas fa-check"></i></button>
                            <button class="btn btn-icon-refined sm" @click="testOpenListAccount(acc.id)" title="连接测试"><i
                                    class="fas fa-plug"></i></button>
                            <button class="btn btn-icon-refined sm" style="color: var(--danger-color);"
                                @click="deleteOpenListAccount(acc.id)" title="删除"><i
                                    class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="setting-item" style="padding: 10px;">
                        <div
                            style="font-weight: 600; color: var(--text-primary); font-size: 14px; margin-bottom: 12px;">
                            <i class="fas fa-plus-circle text-primary" style="margin-right: 6px;"></i> 添加新实例
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <input type="text" v-model="newOpenListAcc.name" class="form-input" placeholder="名称"
                                style="flex: 1; min-width: 100px;" />
                            <input type="text" v-model="newOpenListAcc.api_url" class="form-input" placeholder="API 地址"
                                style="flex: 2; min-width: 200px;" />
                            <input type="password" v-model="newOpenListAcc.api_token" class="form-input"
                                placeholder="Token" style="flex: 1; min-width: 120px;" />
                            <button class="btn btn-primary" @click="doAddOpenListAccount"><i class="fas fa-check"></i>
                                保存</button>
                        </div>
                    </div>
                    <div v-if="openListAccounts.length === 0" class="setting-item"
                        style="padding: 10px; text-align: center;">
                        <div style="color: var(--text-tertiary); font-size: 13px;"><i class="fas fa-info-circle"></i>
                            暂无配置</div>
                    </div>
                </div>
            </div>
            <div class="panel shadow-sm">
                <div class="panel-header" style="padding: 10px;">
                    <div class="panel-title"><i class="fas fa-sliders-h text-primary"></i> 偏好设置</div>
                </div>
                <div style="padding: 0;">
                    <div class="setting-item"
                        style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                        <div style="flex:1;">
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">自动刷新目录</div>
                        </div>
                        <label class="switch"><input type="checkbox" disabled checked><span
                                class="slider round"></span></label>
                    </div>
                    <div class="setting-item"
                        style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px;">
                        <input type="range" class="form-range" min="300" max="1200" step="50"
                            v-model="openListPreviewSize" style="width: 120px;">
                        <button class="btn btn-secondary btn-sm" @click="saveOpenListPreviewSize">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 临时标签页 -->
        <div v-for="tab in openListTempTabs" :key="tab.id"
            v-show="openListSubTab === 'temp' && tab.id === openListActiveTempTabId"
            class="openlist-files-layout animate-fade-in" :class="{ 'video-mode-layout': tab.isVideo }">
            <!-- 视频播放模式 - 使用 Plyr -->
            <div v-if="tab.isVideo" class="openlist-video-tab-view">
                <div class="plyr-player-wrapper">
                    <!-- 顶部操作栏 -->
                    <div class="plyr-player-toolbar">
                        <div class="plyr-toolbar-title">
                            <i class="fas fa-film"></i>
                            <span>{{ tab.name }}</span>
                        </div>
                        <div class="plyr-toolbar-actions">
                            <button class="btn btn-icon-refined" @click="openExternalPlayer"
                                title="外部播放 (PC: PotPlayer / 手机: UC浏览器)">
                                <i class="fas fa-play-circle"></i>
                            </button>
                            <button class="btn btn-icon-refined" @click="openVideoInNewTab" title="在浏览器新标签页打开">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            <button class="btn btn-icon-refined" @click="closeOpenListTempTab(tab.id)" title="关闭标签页">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Plyr 视频元素 -->
                    <video :id="'plyr-video-' + tab.id" class="plyr-video" playsinline></video>
                </div>
            </div>

            <!-- 普通文件列表模式 -->
            <div v-else class="openlist-main-view">
                <div class="openlist-toolbar-standalone">
                    <div class="toolbar-left">
                        <div class="breadcrumb-fluid-container">
                            <button class="bc-node" @click="loadTempTabFiles('/')"><i class="fas fa-home"></i></button>
                            <template v-for="(part, index) in openListTempPathParts" :key="part.path">
                                <i class="fas fa-chevron-right bc-divider"></i>
                                <button class="bc-node"
                                    :class="{ 'active': index === openListTempPathParts.length - 1 }"
                                    @click="loadTempTabFiles(part.path)">{{ part.name }}</button>
                            </template>
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <button class="btn btn-icon-refined" @click="loadTempTabFiles(tab.path, true)"><i
                                class="fas fa-sync-alt"></i></button>
                        <button class="btn btn-secondary btn-sm" @click="mergeToMainTab">
                            <i class="fas fa-layer-group"></i> <span>合并到主列表</span>
                        </button>
                    </div>
                </div>
                <div class="openlist-list-container">
                    <table class="data-table sticky-header" style="width: 100%;">
                        <thead>
                            <tr>
                                <th class="col-name">名称</th>
                                <th class="col-size">大小</th>
                                <th class="col-time hide-on-mobile">修改时间</th>
                            </tr>
                        </thead>
                        <tbody v-if="tab.files.length > 0">
                            <tr v-for="file in tab.files" :key="file.name" @click="handleTempTabFile(file)"
                                @contextmenu="showFileContextMenu($event, file, tab.path)"
                                @touchstart="handleFileTouchStart($event, file, tab.path)"
                                @touchend="handleFileTouchEnd($event)" @touchmove="handleFileTouchMove()"
                                @auxclick.middle.stop="handleMiddleClickItem(file)">
                                <td class="col-name">
                                    <div class="file-cell-main">
                                        <div class="file-icon-wrapper"><i :class="getFileIconClass(file)"></i></div>
                                        <span class="file-name-text">{{ file.name }}</span>
                                    </div>
                                </td>
                                <td class="col-size font-mono text-secondary">{{ getOpenListFileSize(file) || '-' }}
                                </td>
                                <td class="col-time text-tertiary hide-on-mobile">{{ formatDateTime(file.modified) }}
                                </td>
                            </tr>
                        </tbody>
                        <tbody v-else-if="!tab.loading">
                            <tr>
                                <td colspan="3" style="text-align:center; padding: 20px;">目录为空</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 悬停预览图容器 -->
<div id="file-hover-preview" class="file-hover-preview">
    <img id="file-hover-img" src="" referrerpolicy="no-referrer" />
</div>

<!-- 文件右键菜单 -->
<Teleport to="body">
    <div v-if="openListContextMenu.visible" class="openlist-context-menu"
        :style="{ left: openListContextMenu.x + 'px', top: openListContextMenu.y + 'px' }" @click.stop>
        <div class="context-menu-item" @click="handleFileContextAction('open')">
            <i class="fas fa-folder-open"></i>
            <span>{{ openListContextMenu.file?.is_dir ? '打开' : '查看详情' }}</span>
        </div>
        <div v-if="openListContextMenu.file?.is_dir" class="context-menu-item"
            @click="handleFileContextAction('open-new-tab')">
            <i class="fas fa-external-link-alt"></i>
            <span>在新标签页打开</span>
        </div>
        <div v-if="!openListContextMenu.file?.is_dir" class="context-menu-item"
            @click="handleFileContextAction('download')">
            <i class="fas fa-download"></i>
            <span>下载</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" @click="handleFileContextAction('rename')">
            <i class="fas fa-edit"></i>
            <span>重命名</span>
        </div>
        <div class="context-menu-item danger" @click="handleFileContextAction('delete')">
            <i class="fas fa-trash-alt"></i>
            <span>删除</span>
        </div>
    </div>
</Teleport>