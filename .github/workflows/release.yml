# ===================================
# API Monitor è‡ªåŠ¨å‘ç‰ˆå·¥ä½œæµ
# ===================================
# è§¦å‘æ¡ä»¶ï¼š
# - æ‰‹åŠ¨è§¦å‘å¹¶æŒ‡å®šç‰ˆæœ¬å·
# - åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ (v*)
#
# åŠŸèƒ½ï¼š
# - è‡ªåŠ¨ç”Ÿæˆ Release Notes
# - åˆ›å»º GitHub Release
# - æ›´æ–° CHANGELOG.md

name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (å¦‚ 1.0.0ï¼Œä¸éœ€è¦ v å‰ç¼€)"
        required: true
        type: string
      prerelease:
        description: "æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # ç¡®å®šç‰ˆæœ¬å·
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "version=v${VERSION}" >> $GITHUB_OUTPUT
            echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          else
            # ä»Žæ ‡ç­¾èŽ·å–ç‰ˆæœ¬
            TAG="${{ github.ref_name }}"
            echo "version=${TAG}" >> $GITHUB_OUTPUT
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
          fi

      # åˆ›å»ºæ ‡ç­¾ï¼ˆä»…æ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
      - name: Create tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      # ç”Ÿæˆå˜æ›´æ—¥å¿—
      - name: Generate changelog
        id: changelog
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="${{ steps.version.outputs.tag }}"
          
          echo "## ðŸš€ $CURRENT_TAG æ›´æ–°å†…å®¹" > release_notes.md
          echo "" >> release_notes.md
          
          if [ -n "$PREV_TAG" ]; then
            echo "### ðŸ“ æäº¤è®°å½•" >> release_notes.md
            echo "" >> release_notes.md
            
            # æŒ‰ç±»åž‹åˆ†ç±»æäº¤
            echo "#### âœ¨ æ–°åŠŸèƒ½ (feat)" >> release_notes.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^feat" >> release_notes.md || true
            echo "" >> release_notes.md
            
            echo "#### ðŸ› ä¿®å¤ (fix)" >> release_notes.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^fix" >> release_notes.md || true
            echo "" >> release_notes.md
            
            echo "#### ðŸ“š æ–‡æ¡£ (docs)" >> release_notes.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^docs" >> release_notes.md || true
            echo "" >> release_notes.md
            
            echo "#### ðŸ”§ å…¶ä»–" >> release_notes.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^build\|^ci\|^chore\|^refactor\|^perf\|^style\|^test" >> release_notes.md || true
            echo "" >> release_notes.md
          else
            echo "é¦–æ¬¡å‘å¸ƒ" >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“¦ Docker é•œåƒ" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "# ä»Ž GitHub Container Registry æ‹‰å–" >> release_notes.md
          echo "docker pull ghcr.io/${{ github.repository_owner }}/api-monitor:$CURRENT_TAG" >> release_notes.md
          echo "" >> release_notes.md
          echo "# ä»Ž Docker Hub æ‹‰å–" >> release_notes.md
          echo "docker pull ${{ github.repository_owner }}/api-monitor:$CURRENT_TAG" >> release_notes.md
          echo '```' >> release_notes.md
          
          cat release_notes.md

      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Release ${{ steps.version.outputs.tag }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: true

      # è¾“å‡ºæ‘˜è¦
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release ${{ steps.version.outputs.tag }} åˆ›å»ºæˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é¢„å‘å¸ƒ**: ${{ github.event.inputs.prerelease || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release é¡µé¢**: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
