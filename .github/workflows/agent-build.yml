# ===================================
# API Monitor Go Agent Build CI/CD
# ===================================
# Ëß¶ÂèëÊù°‰ª∂Ôºö
# - Êé®ÈÄÅÂà∞ main ÂàÜÊîØÔºàagent-go ÁõÆÂΩïÊúâÂèòÊõ¥Ôºâ
# - ÂàõÂª∫ÁâàÊú¨Ê†áÁ≠æÔºàÂ¶Ç v1.0.0Ôºâ
# - ÊâãÂä®Ëß¶ÂèëÔºàworkflow_dispatchÔºâ

name: Build Go Agent

on:
  push:
    branches: [main]
    tags: ['v*']
    paths:
      - 'agent-go/**'
      - '.github/workflows/agent-build.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Agent ÁâàÊú¨Âè∑'
        required: false
        default: '2.0.0'

permissions:
  contents: write

env:
  GO_VERSION: '1.21'

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: ''
          - goos: linux
            goarch: arm64
            suffix: ''
          - goos: windows
            goarch: amd64
            suffix: '.exe'
          - goos: darwin
            goarch: amd64
            suffix: ''
          - goos: darwin
            goarch: arm64
            suffix: ''

    steps:
      # Ê£ÄÂá∫‰ª£Á†Å
      - name: Checkout repository
        uses: actions/checkout@v4

      # ËÆæÁΩÆ Go ÁéØÂ¢É
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: agent-go/go.sum

      # Ëé∑ÂèñÁâàÊú¨Âè∑
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=2.0.0-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      # ÊûÑÂª∫ Agent
      - name: Build Agent
        working-directory: agent-go
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          OUTPUT_NAME="agent-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.suffix }}"
          go build -ldflags="-s -w -X main.VERSION=${{ steps.version.outputs.version }}" -o "../dist/${OUTPUT_NAME}"
          echo "Built: ${OUTPUT_NAME}"

      # ‰∏ä‰º†ÊûÑÂª∫‰∫ßÁâ©
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/agent-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.suffix }}
          retention-days: 30

  # ÂàõÂª∫ ReleaseÔºà‰ªÖÂú® tag Êé®ÈÄÅÊó∂Ôºâ
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
          body: |
            ## API Monitor Agent v${{ github.ref_name }}

            ### ‰∏ãËΩΩ

            | Âπ≥Âè∞ | Êû∂ÊûÑ | Êñá‰ª∂ |
            |------|------|------|
            | Linux | amd64 | `agent-linux-amd64` |
            | Linux | arm64 | `agent-linux-arm64` |
            | Windows | amd64 | `agent-windows-amd64.exe` |
            | macOS | amd64 | `agent-darwin-amd64` |
            | macOS | arm64 | `agent-darwin-arm64` |

            ### ‰ΩøÁî®ÊñπÊ≥ï

            ```bash
            # ‰∏ãËΩΩ
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/agent-linux-amd64
            chmod +x agent-linux-amd64

            # ËøêË°å
            ./agent-linux-amd64 --id <SERVER_ID> -k <AGENT_KEY> -s <SERVER_URL>
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ËæìÂá∫ÊûÑÂª∫ÊëòË¶Å
  summary:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Build Summary
        run: |
          echo "## üöÄ Go Agent ÊûÑÂª∫ÊàêÂäü" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ÊûÑÂª∫Âπ≥Âè∞" >> $GITHUB_STEP_SUMMARY
          echo "| Âπ≥Âè∞ | Êû∂ÊûÑ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | amd64 |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | arm64 |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | amd64 |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | amd64 |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | arm64 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‰∏ã‰∏ÄÊ≠•" >> $GITHUB_STEP_SUMMARY
          echo "- Âú® Actions È°µÈù¢‰∏ãËΩΩÊûÑÂª∫‰∫ßÁâ©" >> $GITHUB_STEP_SUMMARY
          echo "- ÊàñÂàõÂª∫ Release Ëá™Âä®ÂèëÂ∏É" >> $GITHUB_STEP_SUMMARY
